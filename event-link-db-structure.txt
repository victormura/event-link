DROP TABLE IF EXISTS event_tags;
DROP TABLE IF EXISTS registrations;
DROP TABLE IF EXISTS events;
DROP TABLE IF EXISTS tags;
DROP TABLE IF EXISTS users;
DROP TYPE IF EXISTS user_role;

-- Rolul utilizatorului
CREATE TYPE user_role AS ENUM (
    'student', 
    'organizator'
);

-- Tabela users
CREATE TABLE users (
    id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    role user_role NOT NULL,
    full_name VARCHAR(255)
);

-- Tabela tags
CREATE TABLE tags (
    id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE
);

-- Tabela events
CREATE TABLE events (
    id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    category VARCHAR(100),
    start_time TIMESTAMPTZ NOT NULL,
    end_time TIMESTAMPTZ,
    location VARCHAR(255),
    max_seats INT CHECK (max_seats > 0),
    owner_id INT NOT NULL,
    CONSTRAINT fk_owner
        FOREIGN KEY(owner_id) 
        REFERENCES users(id)
        ON DELETE RESTRICT
);

-- Tabela registrations
CREATE TABLE registrations (
    id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id INT NOT NULL,
    event_id INT NOT NULL,
    registration_time TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT fk_user
        FOREIGN KEY(user_id) 
        REFERENCES users(id)
        ON DELETE CASCADE,
     
    CONSTRAINT fk_event
        FOREIGN KEY(event_id) 
        REFERENCES events(id)
        ON DELETE CASCADE,

    UNIQUE(user_id, event_id)
);

-- Tabela event_tags
CREATE TABLE event_tags (
    event_id INT NOT NULL,
    tag_id INT NOT NULL,

    CONSTRAINT fk_event
        FOREIGN KEY(event_id) 
        REFERENCES events(id)
        ON DELETE CASCADE,
     
    CONSTRAINT fk_tag
        FOREIGN KEY(tag_id) 
        REFERENCES tags(id)
        ON DELETE CASCADE,

    PRIMARY KEY(event_id, tag_id)
);

INSERT INTO users (email, password_hash, role)
VALUES ('organizer@eventlink.ro', 'hash_puternic', 'organizator')
ON CONFLICT (email) DO NOTHING;

INSERT INTO events 
    (title, description, category, start_time, end_time, location, max_seats, owner_id)
VALUES
    ('Conferinta Python 101', 
     'Introducere in programarea Python si web development.', 
     'Tehnologie', 
     '2025-12-05 18:30:00+02',
     '2025-12-05 21:30:00+02', 
     'Sala Mare, Centrul de Afaceri', 
     100, 
     1),
     
    ('Workshop Baze de Date', 
     'Workshop intensiv pe PostgreSQL si SQLAlchemy.', 
     'Educatie', 
     '2025-12-10 10:00:00+00',
     '2025-12-10 13:00:00+00', 
     'Online (Zoom Link)', 
     50, 
     1),
     
    ('Intalnire Casual Networking', 
     'Sesiune Q&A si networking informal.', 
     'Social', 
     '2025-12-15 19:00:00-05',
     '2025-12-15 21:00:00-05', 
     'Lounge Bar Central', 
     20, 
     1);
